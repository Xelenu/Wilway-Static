<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxcyou</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
body {
    margin: 0;
    padding: 0;
    font-family: Impact, 'Poppins', "Arial Black", "Helvetica Neue", Helvetica, Arial, sans-serif;
    color: #e0f7fa; /* Light cyan text for contrast */
}

#searchContainer {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 600px; /* Fixed width for floating effect */
    max-width: 90%; /* Responsive width */
    background: #1c3d4f; /* Dark blue container */
    z-index: 1001;
    padding: 8px;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

#urlInput {
    width: 75%;
    padding: 6px;
    font-size: 14px;
    background: #2a5a75; /* Dark cyan input */
    color: #e0f7fa;
    border: 1px solid #4b8aa6;
    border-radius: 4px;
}

#loadButton {
    padding: 6px 12px;
    font-size: 14px;
    background: darkcyan; /* Dark cyan button */
    color: #e0f7fa;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

#loadButton:hover {
    background: #004d4d; /* Darker cyan on hover */
}

#statusMessage {
    color: #ff6b6b; /* Bright red for errors */
    font-size: 12px;
    margin: 5px 0;
}

#toggleSearchButton {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 6px 12px;
    font-size: 14px;
    z-index: 1002;
    background: #006666; /* Dark cyan button */
    color: #e0f7fa;
    border: none;
    border-radius: 2px;
    cursor: pointer;
}

#toggleSearchButton:hover {
    background: #004d4d; /* Darker cyan on hover */
}

#contentFrame {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    border: none;
    z-index: 1000;
}

#loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(10, 30, 43, 0.7); /* Dark blue overlay */
    display: flex;
    align-items: center;
    justify-content: center;
    color: #e0f7fa;
    font-size: 20px;
    z-index: 1003;
}

.hidden {
    display: none !important;
}

.error-page {
    font-family: Impact, Poppins, sans-serif;
    color: #e0f7fa;
    text-align: center;
    font-size: 18px;
    padding: 50px;
    background-color: #1c3d4f; /* Dark blue error page */
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.error-page button {
    margin-top: 20px;
    padding: 8px 16px;
    font-size: 14px;
    background: #006666; /* Dark cyan button */
    color: #e0f7fa;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.error-page button:hover {
    background: #004d4d; /* Darker cyan on hover */
}
    </style>
</head>
<body>
    <div id="searchContainer">
        <input type="text" id="urlInput" placeholder="Where do you want to go?">
        <button id="loadButton">Go</button>
        <div id="statusMessage"></div>
    </div>
    <button id="toggleSearchButton">ðŸ”½</button>
    <iframe id="contentFrame"></iframe>
    <div id="loadingOverlay" class="hidden">Loading...</div>

<script>
    const iframe = document.querySelector('iframe') || createIframe();
const loadingOverlay = createLoadingOverlay();
const urlInput = createUrlInput();
const baseProxyUrl = 'https://toothpaste.bekekes390.workers.dev/?url=';

function createIframe() {
  const iframe = document.createElement('iframe');
  iframe.id = 'proxy-iframe';
  iframe.style.cssText = 'width: 100%; height: 80vh; border: none; display: none;';
  document.body.appendChild(iframe);
  return iframe;
}

function createLoadingOverlay() {
  const overlay = document.createElement('div');
  overlay.id = 'loading-overlay';
  overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); color: white; display: none; z-index: 9999; text-align: center; line-height: 100vh;';
  overlay.textContent = 'Loading...';
  document.body.appendChild(overlay);
  return overlay;
}

function createUrlInput() {
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Enter URL (e.g., https://szvy.win)';
  input.style.cssText = 'width: 100%; padding: 10px; margin: 10px 0; font-size: 16px;';
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && input.value.trim()) {
      loadIframe(input.value.trim());
    }
  });
  document.body.insertBefore(input, iframe);
  return input;
}

function showLoadingOverlay() {
  console.log('Showing loading overlay');
  loadingOverlay.style.display = 'block';
}

function hideLoadingOverlay() {
  console.log('Hiding loading overlay');
  loadingOverlay.style.display = 'none';
}

async function loadIframe(url) {
  if (!url.match(/^https?:\/\//)) {
    url = 'https://' + url;
  }
  showLoadingOverlay();
  console.log(`Loading URL: ${url}`);

  try {
    const proxyUrl = `${baseProxyUrl}${encodeURIComponent(url)}`;
    console.log(`Proxy URL: ${proxyUrl}`);

    // Fetch content to bypass CSP
    const response = await fetch(proxyUrl);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    let html = await response.text();

    // Rewrite URLs in HTML
    html = rewriteUrls(html, url);

    // Inject libraries and fixes
    html = html.replace('</head>', `
      <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/cursor-effects@1.1.1/dist/cursor-effects.min.js"></script>
      <script>
        if (typeof particlesJS !== 'undefined') {
          particlesJS('particles-js', {
            particles: {
              number: { value: 80, density: { enable: true, value_area: 800 } },
              color: { value: '#ffffff' },
              shape: { type: 'circle' },
              opacity: { value: 0.5, random: false },
              size: { value: 3, random: true },
              line_linked: { enable: true, distance: 150, color: '#ffffff', opacity: 0.4, width: 1 },
              move: { enable: true, speed: 6, direction: 'none', random: false, straight: false, out_mode: 'out', bounce: false }
            },
            interactivity: {
              detect_on: 'canvas',
              events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' }, resize: true },
              modes: { repulse: { distance: 200, duration: 0.4 }, push: { particles_nb: 4 } }
            },
            retina_detect: true
          });
        }
        if (typeof cursorEffects !== 'undefined') {
          new cursorEffects.rainbowCursor();
        }
        (function() {
          const originalFetch = window.fetch;
          window.fetch = function(url, options) {
            if (url.includes('discord.com/api')) {
              console.log('Proxying Discord API: ' + url);
              return fetch('https://cors-anywhere.herokuapp.com/' + url, options).then(res => {
                if (!res.ok) {
                  throw new Error('Discord API fetch failed');
                }
                return res;
              });
            } else if (url.includes('github.com/szvy?action=show&controller=profiles')) {
              console.log('Rewriting GitHub API');
              url = 'https://api.github.com/users/szvy';
            } else if (!url.startsWith('http') && !url.startsWith('//')) {
              console.log('Rewriting relative URL: ' + url);
              url = '${baseProxyUrl}' + encodeURIComponent(new URL(url, '${url}').href);
            }
            return originalFetch(url, options);
          };

          document.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link && link.href && !link.href.startsWith('#')) {
              e.preventDefault();
              console.log('Intercepted navigation to: ' + link.href);
              window.parent.postMessage({ type: 'navigate', url: link.href }, '*');
            }
          });

          document.addEventListener('submit', (e) => {
            const form = e.target.closest('form');
            if (form) {
              e.preventDefault();
              const formData = new FormData(form);
              const action = form.action || '${url}';
              const newUrl = new URL(action);
              formData.forEach((value, key) => newUrl.searchParams.append(key, value));
              console.log('Intercepted form submission to: ' + newUrl.href);
              window.parent.postMessage({ type: 'navigate', url: newUrl.href }, '*');
            }
          });
        })();
      </script>
    </head>`);

    // Load content in same-origin iframe to bypass CSP
    const blob = new Blob([html], { type: 'text/html' });
    const blobUrl = URL.createObjectURL(blob);
    iframe.src = blobUrl;
    iframe.style.display = 'block';

    iframe.onload = () => {
      console.log('Iframe loaded successfully');
      hideLoadingOverlay();
    };

    iframe.onerror = (error) => {
      console.error(`Iframe failed to load: ${error}`);
      hideLoadingOverlay();
      fallbackToAlternativeUrl(url);
    };

    setTimeout(() => {
      if (!iframe.contentDocument) {
        console.warn('Iframe load check timeout');
        hideLoadingOverlay();
        fallbackToAlternativeUrl(url);
      }
    }, 15000);
  } catch (error) {
    console.error(`Error loading iframe: ${error.message}`);
    hideLoadingOverlay();
    fallbackToAlternativeUrl(url);
  }
}

function rewriteUrls(html, baseUrl) {
  return html.replace(/(href|src|action)=["']([^"']+)["']/g, (match, attr, value) => {
    if (value.startsWith('http') || value.startsWith('//') || value.startsWith('#')) {
      return match;
    }
    const absoluteUrl = new URL(value, baseUrl).href;
    return `${attr}="${baseProxyUrl}${encodeURIComponent(absoluteUrl)}"`;
  });
}

function fallbackToAlternativeUrl(originalUrl) {
  const fallbackUrl = originalUrl.includes('szvy.win') ? 'https://github.com/szvy/central' : 'https://szvy.win';
  console.log(`Falling back to: ${fallbackUrl}`);
  urlInput.value = fallbackUrl;
  loadIframe(fallbackUrl);
}

window.addEventListener('message', (e) => {
  if (e.data.type === 'navigate') {
    console.log(`Intercepted navigation to: ${e.data.url}`);
    urlInput.value = e.data.url;
    loadIframe(e.data.url);
  }
});
</script>
</body>
</html>
